---
title: "GitHub Actions ã‚’ä½¿ã„å­ãƒªãƒã‚¸ãƒˆãƒªãŒ Push ã•ã‚ŒãŸæ™‚ã€è¦ªãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒ«ãƒªã‚¯ã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["github","ci","submodule","githubactions"]
published: true
---
ãƒ¡ãƒ¢ã§ã™ã€‚
# ãƒ¢ãƒãƒ™
è¨³ã‚ã£ã¦è‡ªåˆ†ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ä»–ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ submodule ã¨ã—ã¦åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚git submodule ã®ä»•æ§˜ã§ã¯ç‰¹å®šã®ã‚³ãƒŸãƒƒãƒˆã‚’å‚ç…§ã—ã¦ã„ã‚‹å½¢ã¨ãªã‚‹ãŸã‚ã€å¸¸ã« HEAD ã‚’å‚ç…§ã®ã‚ˆã†ãªã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

[Git Tools - Submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules)

ã‚ˆã£ã¦è‡ªå‹•ã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã§ããªã„ã‹ãªã¨è€ƒãˆã¾ã—ãŸã€‚
# æ–¹é‡
- github actions ã‚’ä½¿ç”¨
- å­ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰è¦ªãƒªãƒã‚¸ãƒˆãƒªã«å‘ã‘ã¦ã¯ [repository_dispatch](https://docs.github.com/en/actions/reference/events-that-trigger-workflows#repository_dispatch) ã§è§£æ±º
- ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆã¯[peter-evans/create-pull-request@v3](https://github.com/peter-evans/create-pull-request)ã‚’ä½¿ç”¨
# ä½œæˆã—ãŸã‚‚ã®
- push æ™‚ã«å­ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰è¦ªãƒªãƒã‚¸ãƒˆãƒªã¸POST ã‚’é€ä¿¡ã—ã€repository_dispatch ãƒˆãƒªã‚¬ã‚’èµ·å‹•ã™ã‚‹ã‚‚ã®
- repository_dispatch ã§å¾…ã¡å—ã‘ã€å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚“ã ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã‚‚ã®

ã«åˆ†ã‘ã¾ã™
## submoduleå´
push ã‚’ãƒˆãƒªã‚¬ã¨ã—ã¦ POST ã§å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒªã‚’ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ãã ã‘ãªã®ã§å˜ç´”ã§ã™ã€‚

```yml:update-submodule.yml
name: Dispatch
on:
  push:
    branches: [ master ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: |
          curl -X POST -H "Authorization: token ${{ secrets.AUTO_PR_TOKEN }}" -H "Accept: application/vnd.github.everest-preview+json" -d '{"event_type": "update-submodule"}' -i  https://api.github.com/repos/{é€ä¿¡å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ or çµ„ç¹”}/{é€ä¿¡å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª}/dispatches
```

master ãƒ–ãƒ©ãƒ³ãƒã¸ã® push ã§èµ·å‹•ã—ã€crul ã§å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ event_type ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚

```url
 https://api.github.com/repos/{é€ä¿¡å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ or çµ„ç¹”}/{é€ä¿¡å¯¾è±¡ãƒªãƒã‚¸ãƒˆãƒª}/dispatches
```

ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã«é€ä¿¡ã—ãŸã„ãƒªãƒã‚¸ãƒˆãƒªã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

```
token ${{ secrets.AUTO_PR_TOKEN }}
```

ã¨ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã¯ãƒªãƒã‚¸ãƒˆãƒªã«è¨­å®šã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® Settings â†’ Developer settings â†’ Personal access tokens ã§ç™ºè¡Œã—ãŸã‚‚ã®ã‚’
ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¿ãƒ–ã® Settings â†’ Secrets â†’ New repository secret ã§ç™»éŒ²ã§ãã¾ã™ã€‚
Personal access tokensã®ç™ºè¡Œæ™‚ã«æ¨©é™ã‚’æŒ‡å®šã§ãã¾ã™ãŒã€ã“ã®è¨˜äº‹ã§ã®æ“ä½œã§ã¯repo ã‚¹ã‚³ãƒ¼ãƒ—ãŒã‚ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
![ãƒˆãƒ¼ã‚¯ãƒ³](https://raw.githubusercontent.com/uesugi6111/zenn-article/master/img/17a9f1cc47118df0903a/token.png)

```
-d '{"event_type": "update-submodule"}' 
```

ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã§æŒ‡å®šã—ãŸæ–‡å­—åˆ—åˆè‡´ã—ãŸå ´åˆã®ã¿ã€è¦ªãƒªãƒã‚¸ãƒˆãƒªã®WorkflowãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

## è¦ªãƒªãƒã‚¸ãƒˆãƒªå´
è¦ªãƒªãƒã‚¸ãƒˆãƒªã¯ [repository_dispatch](https://docs.github.com/en/actions/reference/events-that-trigger-workflows#repository_dispatch) ã§å¾…ã¡å—ã‘ã€ãƒ—ãƒ«ãƒªã‚¯ã‚’ä½œæˆã™ã‚‹ã¨ã“ã‚ã¾ã§ã§ã™ã€‚

```yml:autoPR.yml
name: Update submodule Pull Request
on:
  repository_dispatch:
    types: [update-submodule]
jobs:
  patch:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@master 
        with:
          submodules: true

      - run: git submodule update --remote

      - name: Create Pull Request 
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          title: Update submodule.
          labels: Auto PR
          branch: auto-pr/update-submodule 
          branch-suffix : timestamp 
          commit-message: auto update submodule
          base : master
          delete-branch: true
          token: ${{ secrets.AUTO_PR_TOKEN }}
```

repository_dispatch ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— "update-submodule" (å­ãƒªãƒã‚¸ãƒˆãƒªã§æŒ‡å®š) ã‚’æŒ‡å®šã—å¾…ã¡å—ã‘ã¦ã„ã¾ã™ã€‚
step1ã§ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å«ã‚ãŸcheckoutã€step2 ã§ submodule ã®æ›´æ–°ã‚’è¡Œã„ã¾ã™ã€‚
step3ã®

```yml:
      - name: Create Pull Request 
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          title: Update submodule.
          labels: Auto PR
          branch: auto-pr/update-submodule 
          branch-suffix : timestamp 
          commit-message: auto update submodule
          base : master
          delete-branch: true
          token: ${{ secrets.AUTO_PR_TOKEN }}
```

ã«ã¤ã„ã¦ã¯ [peter-evans/create-pull-request@v3](https://github.com/peter-evans/create-pull-request)ã«è©³ç´°ãªèª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚
ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®çŠ¶æ…‹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã€æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã‚‚ã®ã§ã™ã€‚
ã“ã“ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è§£èª¬ã§ã™ã€‚

- title: ä½œæˆã•ã‚Œã‚‹ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«
- labels: ä½œæˆã•ã‚ŒãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»˜ã‘ã‚‰ã‚Œã‚‹ãƒ©ãƒ™ãƒ«
- branch: ãƒãƒ¼ã‚¸å…ƒã¨ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒ
- branch-suffix : (random, timestamp, short-commit-hash) ã“ã®å€¤ã‚’è¨­å®šã™ã‚‹ã¨ branch ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è¨­å®šã—ãŸæ–‡å­—åˆ—ã‚’ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã¨ã—ã¦ãƒ–ãƒ©ãƒ³ãƒãŒä½œæˆã•ã‚Œã¾ã™ã€‚ãƒ–ãƒ©ãƒ³ãƒã®ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒæŒ‡å®šã•ã‚ŒãŸå½¢å¼ã§è¨­å®šã•ã‚Œã¾ã™ã€‚(é€†ã«ã“ã®å€¤ã‚’è¨­å®šã—ãªã„å ´åˆã¯ branch ã§æŒ‡å®šã—ãŸãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ã¦ã„ã‚‹å‰æã§å‹•ã„ã¦ã„ã‚‹ï¼Ÿæ°—ãŒã—ã¾ã™ã€‚)
- commit-message: ã‚³ãƒŸãƒƒãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- base : æ´¾ç”Ÿå…ƒã®ãƒ–ãƒ©ãƒ³ãƒã¨ãªã‚Šã¾ã™ã€‚æŒ‡å®šã—ãªã„å ´åˆã¯WorkflowãŒå‹•ã„ã¦ã„ã‚‹ãƒ–ãƒ©ãƒ³ãƒãŒæŒ‡å®šã•ã‚Œã¾ã™ã€‚
- delete-branch: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã«ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤(boolean)
- token: ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯å­ãƒªãƒã‚¸ãƒˆãƒªã¨åŒæ§˜ã®æ–¹æ³•ã§è¦ªãƒªãƒã‚¸ãƒˆãƒªã«ã‚‚ä½œæˆã—ãŸç½®ã„ãŸã‚‚ã®ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

## å®Ÿè¡Œçµæœ

![å®Ÿè¡Œçµæœ](https://raw.githubusercontent.com/uesugi6111/zenn-article/master/img/17a9f1cc47118df0903a/pr.png)

# ãŠã‚ã‚Š
ä¸€é€šã‚Šèª¿ã¹ã¦ä½œæˆã—ã¦ã¿ã¾ã—ãŸãŒ github actions ä¾¿åˆ©ã ãªãƒ¼ã¨ã„ã†æ„Ÿæƒ³ã§ã™ã€‚
è‡ªåˆ†ã§ã‚‚ãªã«ã‹ä½œã£ã¦ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã§å…¬é–‹ã§ããŸã‚‰ã¨æ€ã„ã¾ã™ã€‚
